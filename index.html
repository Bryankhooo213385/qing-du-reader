<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>清读 - 纯净无障碍阅读器</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #1a1a1a;
            --accent-color: #0056b3;
            --card-bg: #ffffff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --text-color: #e0e0e0;
                --accent-color: #90caf9;
                --card-bg: #1e1e1e;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.8;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        :focus {
            outline: 4px solid var(--accent-color);
            outline-offset: 2px;
        }

        header {
            background-color: var(--card-bg);
            padding: 1rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        main {
            max-width: 800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }

        .btn-outline {
            background-color: transparent;
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
        }

        .import-section {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            border: 2px dashed var(--accent-color);
            margin-bottom: 2rem;
        }

        .content-area p {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            text-align: justify;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
        }

        .book-item {
            background: var(--card-bg);
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay" role="alert" aria-busy="true">
    <div style="font-size: 1.5rem;" id="loading-msg">正在努力解析书籍...</div>
    <div id="progress" style="margin-top:10px;">进度: 0%</div>
</div>

<header>
    <div id="nav-title" role="heading" aria-level="1" style="font-weight: bold;">清读书架</div>
    <button class="btn btn-outline" onclick="showShelf()" id="btn-shelf" style="display:none;">返回书架</button>
</header>

<main id="app-root" aria-live="polite"></main>

<script>
    localforage.config({ name: 'PureRead', storeName: 'books' });
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let bookList = [];
    const sleep = (ms) => new Promise(res => setTimeout(res, ms));

    async function init() {
        bookList = await localforage.getItem('list') || [];
        showShelf();
    }

    async function showShelf() {
        const root = document.getElementById('app-root');
        document.getElementById('nav-title').textContent = "书架";
        document.getElementById('btn-shelf').style.display = 'none';

        let html = `
            <section class="import-section">
                <h2>添加书籍</h2>
                <p>支持 EPUB 和 PDF 格式</p>
                <input type="file" id="file-in" accept=".pdf,.epub" style="display:none" onchange="handleFile(event)">
                <button class="btn" onclick="document.getElementById('file-in').click()">选择电子书</button>
            </section>
            <h2 style="margin-top:20px;">我的藏书</h2>
            <div id="shelf-list"></div>
        `;
        root.innerHTML = html;

        const listDiv = document.getElementById('shelf-list');
        if (bookList.length === 0) {
            listDiv.innerHTML = "<p>书架空空如也，请先导入书籍。</p>";
            return;
        }

        bookList.forEach((book, idx) => {
            const div = document.createElement('div');
            div.className = 'book-item';
            div.innerHTML = `
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:1.1rem;">${escapeHTML(book.title)}</div>
                    <div style="font-size:0.9rem; opacity:0.7;">${escapeHTML(book.author)}</div>
                </div>
                <button class="btn" onclick="openBook('${book.id}')">阅读</button>
                <button class="btn btn-outline" style="margin-left:8px; border-color:red; color:red;" onclick="deleteBook('${book.id}')">删除</button>
            `;
            listDiv.appendChild(div);
        });
    }

    async function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        const loading = document.getElementById('loading');
        loading.style.display = 'flex';
        
        try {
            let chapters = [];
            if (file.name.toLowerCase().endsWith('.pdf')) {
                chapters = await processPDF(file);
            } else {
                chapters = await processEpub(file);
            }

            const bookId = 'id_' + Date.now();
            const newBook = { id: bookId, title: file.name.replace(/\.[^/.]+$/, ""), author: "本地导入", chapters };
            
            await localforage.setItem('content_' + bookId, newBook);
            bookList.push({ id: newBook.id, title: newBook.title, author: newBook.author });
            await localforage.setItem('list', bookList);
            
            showShelf();
        } catch (err) {
            alert("解析失败: " + err.message);
        } finally {
            loading.style.display = 'none';
        }
    }

    async function processPDF(file) {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;
        let res = [];
        for (let i = 1; i <= pdf.numPages; i++) {
            await sleep(30);
            document.getElementById('progress').textContent = `进度: ${Math.round((i/pdf.numPages)*100)}%`;
            const page = await pdf.getPage(i);
            const text = await page.getTextContent();
            const content = text.items.map(s => s.str).join(" ");
            res.push({ title: `第 ${i} 页`, content: `<p>${escapeHTML(content)}</p>` });
        }
        return res;
    }

    // 已移植读取导航索引的逻辑
    async function processEpub(file) {
        const buffer = await file.arrayBuffer();
        const book = ePub(buffer);
        await book.ready;
        
        // 获取书籍内置的目录导航
        const navigation = await book.loaded.navigation;
        const spine = book.spine;
        let res = [];

        for (let i = 0; i < spine.items.length; i++) {
            await sleep(50);
            document.getElementById('progress').textContent = `进度: ${Math.round((i/spine.items.length)*100)}%`;
            const item = spine.items[i];
            
            // 【核心修改点】：优先从导航(NCX/TOC)中找标题
            let chTitle = `章节 ${i + 1}`;
            const navItem = navigation.get(item.href);
            if (navItem && navItem.label) {
                chTitle = navItem.label.trim();
            }

            const doc = await loadEpubItem(book, item.href);
            if (doc && doc.body) {
                let html = "";
                const nodes = doc.body.querySelectorAll('h1, h2, h3, h4, p, li');
                nodes.forEach(n => {
                    const txt = n.innerText.trim();
                    if (txt) {
                        const tag = n.tagName.toLowerCase();
                        html += `<${tag}>${escapeHTML(txt)}</${tag}>`;
                    }
                });

                if (!html) {
                    const lines = doc.body.innerText.split(/\n+/);
                    lines.forEach(l => { if(l.trim()) html += `<p>${escapeHTML(l.trim())}</p>`; });
                }

                if (html) res.push({ title: chTitle, content: html });
            }
        }
        return res;
    }

    async function loadEpubItem(book, href) {
        const raw = await book.load(href);
        if (raw instanceof Document) return raw;
        return new DOMParser().parseFromString(raw, 'application/xhtml+xml');
    }

    async function openBook(id) {
        const book = await localforage.getItem('content_' + id);
        if (!book) return;
        
        const root = document.getElementById('app-root');
        document.getElementById('nav-title').textContent = book.title;
        document.getElementById('btn-shelf').style.display = 'block';

        let html = `<h1 id="top-h" tabindex="-1">${escapeHTML(book.title)}</h1><nav aria-label="目录"><ul style="list-style:none; padding:0;">`;
        book.chapters.forEach((ch, i) => {
            html += `<li style="margin:15px 0;"><button class="btn btn-outline" style="width:100%; text-align:left;" onclick="readChapter('${id}', ${i})">${escapeHTML(ch.title)}</button></li>`;
        });
        html += `</ul></nav>`;
        root.innerHTML = html;
        document.getElementById('top-h').focus();
    }

    async function readChapter(id, idx) {
        const book = await localforage.getItem('content_' + id);
        const ch = book.chapters[idx];
        const root = document.getElementById('app-root');

        root.innerHTML = `
            <article>
                <h1 id="ch-h" tabindex="-1">${escapeHTML(ch.title)}</h1>
                <div class="content-area">${ch.content}</div>
            </article>
            <div style="margin-top:30px; display:flex; justify-content:space-between;">
                ${idx > 0 ? `<button class="btn" onclick="readChapter('${id}', ${idx-1})">上一章</button>` : '<span></span>'}
                <button class="btn btn-outline" onclick="openBook('${id}')">目录</button>
                ${idx < book.chapters.length - 1 ? `<button class="btn" onclick="readChapter('${id}', ${idx+1})">下一章</button>` : '<span></span>'}
            </div>
        `;
        window.scrollTo(0,0);
        setTimeout(() => document.getElementById('ch-h').focus(), 100);
    }

    async function deleteBook(id) {
        if (!confirm("确定删除吗？")) return;
        bookList = bookList.filter(b => b.id !== id);
        await localforage.setItem('list', bookList);
        await localforage.removeItem('content_' + id);
        showShelf();
    }

    // 辅助函数：转义HTML防止恶意脚本，同时也保证文本安全
    function escapeHTML(str) {
        const p = document.createElement('p');
        p.textContent = str;
        return p.innerHTML;
    }

    window.onload = init;
</script>
</body>
</html>
